import React, { useState, useMemo } from 'react';
import { useProducts } from '../../../entities/product/api';
import { SearchInput } from '../../../features/product-search';
import { ProductCard } from '../../../widgets/product-card';
import { LoadingGrid, EmptyState } from '../../../shared/ui';

const CATEGORIES = [
  { id: 'all', name: '–í—Å–µ', emoji: 'üõçÔ∏è' },
  { id: 'pod-systems', name: 'Pod-—Å–∏—Å—Ç–µ–º—ã', emoji: 'üîã' },
  { id: 'disposable', name: '–û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ', emoji: 'üí®' },
  { id: 'liquids', name: '–ñ–∏–¥–∫–æ—Å—Ç–∏', emoji: 'üß™' }
];

export const CatalogPage: React.FC = () => {
  const navigate = useNavigate();
  const { data: products = [], isLoading, error } = useProducts();
  
  const [searchResults, setSearchResults] = useState<Product[]>([]);
  const [selectedCategory, setSelectedCategory] = useState('all');
  const [viewMode, setViewMode] = useState<'grid' | 'list'>('list');
  const [isSearching, setIsSearching] = useState(false);

  // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–æ–≤
  const displayProducts = useMemo(() => {
    if (isSearching && searchResults.length >= 0) {
      return searchResults;
    }
    
    if (selectedCategory === 'all') {
      return products;
    }
    
    return products.filter(product => product.category === selectedCategory);
  }, [products, searchResults, selectedCategory, isSearching]);

  const handleSearchResults = (results: Product[]) => {
    setSearchResults(results);
    setIsSearching(true);
  };

  if (isLoading) return <LoadingGrid />;
  if (error) return <EmptyState title="–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏" />;

  return (
    <div className="space-y-4">
      {/* –ü–æ–∏—Å–∫ */}
      <SearchInput 
        onResultsChange={handleSearchResults}
        placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤..."
      />

      {/* –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ */}
      <div className="flex gap-2 overflow-x-auto pb-2 hide-scrollbar">
        {CATEGORIES.map(category => (
          <button
            key={category.id}
            onClick={() => {
              setSelectedCategory(category.id);
              setIsSearching(false);
            }}
            className={`px-4 py-2 rounded-full whitespace-nowrap transition-colors ${
              selectedCategory === category.id && !isSearching
                ? 'bg-tg-button text-tg-button-text'
                : 'bg-tg-secondary-bg text-tg-text'
            }`}
          >
            {category.emoji} {category.name}
          </button>
        ))}
      </div>

      {/* –¢–æ–≤–∞—Ä—ã */}
      <div className={
        viewMode === 'grid' 
          ? 'grid grid-cols-2 gap-3' 
          : 'space-y-3'
      }>
        {displayProducts.map(product => (
          <ProductCard
            key={product.id}
            product={product}
            variant={viewMode}
            onClick={() => navigate(`/product/${product.id}`)}
          />
        ))}
      </div>

      {displayProducts.length === 0 && (
        <EmptyState 
          title="–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
          description="–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é"
        />
      )}
    </div>
  );
};